---
title: "Rarefy clean data and plot"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Resource
All the functions are contained in `funs_rarefy.R` in `scripts` directory. 

```{r}
source("scripts/funs_rarefy.R")
```


## Dataset preparation

The dataset that QIIME2 returns is called `observed_features.csv` and it was obtained with the `qiime diversity alpha-rarefaction plugin`. 
Usually, the dataset has a column for samples names (`sample-id`) at the begining  and other categorical columns like `description`, `site`, etc. at the end it depends on your project.  

The dataset looks like this:

```{r, include=FALSE}
obs <- read.csv("datasets/observed_features.csv")
head(obs)
```

To use the functions contained in `funs_rarefy.R` you have to choose one character column, your sample ids or a categorical variable. In this case I'll use my sample-ids, at the of this dataset I have a categorical variable called `site`, I'll delete it. 

```{r}
library(tidyverse)
library(magrittr)

obs %<>% select(-site)

```

## Process

### First step: Data clean

We have to clean the colnames of the dataset, in order to obtain only the depth of reads and the number of the iterations. Remember that for each depth there are 10 iterations. The first function (`clean_rarefy_data()`) do that. 

**Parameters** of `clean_rarefy_data()`:
  `data` : A dataset with just one categorical column.
  `catCol`:  1 or 101, the number represents de number of the categorical column, could be: 
      - 1 if your column are at the beginig
      - 101 if you column are at the end
      
**Output**: A list, each object of that list is a dataset. The number of datasets contained in the list depends on the number of samples or categories you have. Each dataset contains the 10 iterations from each read depth.

```{r, echo=TRUE, include = TRUE, warning=FALSE}
obs1 <- clean_rarefy_data(obs, 1)
obs1[[1]]

```


### Second step: Mean and sd

The second step is to obtain the average and the standard deviation of the number of sequences obtained in each iteration at each depth. We can do that with the function `rarefy_by()`. 

**Parameters**: 
  `L`: The list obtained in the last step.

**Output**: Another list.
  
```{r, echo=TRUE, include = TRUE, warning=FALSE}

obs2 <- rarefy_by(obs1)
obs2[[1]]

```

### Third step: More data clean

So, at this time we have the mean and sd of the 10 iterations for each depth. Now, we have to transform the column `Depth` to a numeric and unite all the list objects in a only dataset. In order to do this, we use the function `clean_rarefy_data2()`.

**Parameters**:
  `L`: The list obtained in the last step.
  
```{r}
obs3 <- clean_rarefy_data2(obs1)
class(obs3)
head(obs3)
```


### Fourth step: Plot

Finally just plot the last object. 

```{r}

ggplot(obs3, aes(x = depth, 
                 y = sequences,
                 group = category,
                 color = category)) +
    geom_line() +
    geom_point(alpha = 0.5)+
    theme_bw() +
    theme(legend.position = "bottom")+
    labs(x =" Depth sequencing", 
         y = "ASVs observed") 
```

Or you could add another column with more categories like site or treatment and get a plot with more information. 

```{r}

obs3 %<>% mutate(site = ifelse(grepl("^a", .$category), "A", "B"))
head(obs3)
```


Plot

```{r}
ggplot(obs3, aes(x = depth, 
                 y = sequences,
                 group = category,
                 color = site)) +
    geom_line() +
    geom_point(alpha = 0.5)+
    theme_bw() +
    theme(legend.position = "bottom")+
    labs(x =" Depth sequencing", 
         y = "ASVs observed") 
```

